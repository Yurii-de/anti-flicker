# Система стабилизации видеосегментации (Anti-Flicker)

Этот проект реализует систему для уменьшения временной нестабильности (мерцания) масок сегментации на видео.

## Структура проекта

- `main.py`: Основной скрипт запуска. Выполняет полный цикл обработки.
- `io_utils.py`: Отвечает за загрузку и сохранение видео.
- `seg_utils.py`: Использует предобученную модель Mask R-CNN для генерации начальных масок.
- `smooth_utils.py`: Реализует временное сглаживание.
- `metric_utils.py`: Вычисляет метрики временной стабильности (IoU между соседними кадрами).
- `vis_utils.py`: Генерирует видео сравнения и графики.

## Установка

1.  **Окружение**:

    Убедитесь, что у вас установлен Python 3.9+.
    Рекомендуется использовать `uv` для управления зависимостями.

    ```bash
    uv venv
    source .venv/bin/activate
    uv pip install -r requirements.txt
    ```

2.  **Подготовка данных**:

    Поместите ваше видео `video.mp4` в папку `videos`.

## Использование

Запустите основной скрипт:

```bash
python main.py
```

Скрипт выполнит следующие действия:
1.  Загрузит `video.mp4`.
2.  Запустит Mask R-CNN для получения покадровых масок.
3.  **Эксперимент**: Запустит сглаживание с разными размерами окна (`window_size`), чтобы найти оптимальный параметр.
4.  Вычислит метрики стабильности (IoU) для каждого варианта.
5.  Сгенерирует файлы результатов:
    *   `comparison.mp4`: Видео, сравнивающее оригинальные маски и лучший результат сглаживания.
    *   `stability_plot.png`: График изменения IoU от кадра к кадру.
    *   `experiment_plot.png`: График зависимости средней стабильности от размера окна.

## Описание метода

### Сегментация

Используется предобученную модель **Mask R-CNN** (ResNet50 FPN) из библиотеки `torchvision`. Для демонстрации работы алгоритма стабилизации используется относительно низкий порог уверенности, что может приводить к появлению шума и мерцания в исходных масках.

### Метрика нестабильности

Измеряю временную стабильность, используя **Intersection over Union (IoU)** между масками соседних кадров:
$$ \text{Stability} = \frac{1}{T-1} \sum_{t=1}^{T-1} \text{IoU}(M_t, M_{t+1}) $$
Более высокие значения указывают на более стабильные маски (при условии плавного движения объекта).

### Сглаживание
Используем **Временное скользящее среднее (Temporal Moving Average)** на картах вероятностей.
Для каждого пикселя $(x, y)$ в момент времени $t$, сглаженная вероятность равна:
$$ P_{smooth}(x, y, t) = \frac{1}{2k+1} \sum_{i=-k}^{k} P_{raw}(x, y, t+i) $$
где $2k+1$ — это размер окна (`window_size`).
Итоговая бинарная маска получается пороговым отсечением $P_{smooth} > 0.5$.

Был проведен эксперимент с размером окна сглаживания:

Слишком большие окна дают высокую метрику стабильности, но маска просто "застывает" и перестает соответствовать движению объекта, что визуально выглядит плохо. Поэтому был сделан выбор в пользу небольших значений окон.

## Результаты


Система автоматически подбирает лучший размер окна и сохраняет визуализацию. Ожидается, что сглаженные маски будут показывать значительно более высокую стабильность и меньше визуального мерцания по сравнению с сырыми покадровыми предсказаниями.